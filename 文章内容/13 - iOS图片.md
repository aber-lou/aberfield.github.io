---
layout: mypost
title: iOS图片
---

## 图片加载的工作流

1.假设我们使用init(contentsOfFile:```filePath```)的方法从磁盘中加载一张图片，这个时候图片并没有将数据读到内存并解压缩。

2.当我们将UIImage赋值给UIimageView，这个时候会有一个隐式的CATransaction捕捉到UIIMageView图层树的变化，这个CATransaction会在下一个runloop循环来到之时被处理掉。

3.runloop到来之时，CoreAnimation 提交隐式的transaction，这个过程会对图片进行copy，而受图片是否字节对齐等因素的影响，这个copy操作可能会涉及到一下部分或者全部步鄹:

    a. 分配内存缓冲区用户管理文件IO和解压缩操作
    b. 将文件数据从磁盘读到内存中
    c. 将压缩的图片数据解码程未压缩的位图(bitmap)形式，这是一个很耗时的CPU操作
    d. 最后Core Animation使用位图形式的数据渲染UIImageView图层。

这一部分操作默认是在主线程操作。所以像图片解压缩这个耗时的CPU操作很可能就是导致我们页面卡顿的原因。比如加载图片较多，同时还是涉及到其他内容的计算，很可能这一部分的处理时间就会超过16.7ms 导致掉帧问题。在快速滑动同时加载图片的列表上，这个问题非常明显。

## 关于位图

+ 位图(bitmap),也称作点阵图像或绘制图像，是由像素点组成的。所以图像的质量清晰度跟单位面积里面像素点的多少有很大的关系，也就是分辨率大小。一般我们得颜色编码可以分为两种，一种是RGB，一种是CMYK。常用于程序开发中的一般都是RGB颜色编码。

+ 颜色表:从位图图片中选择最有代表性的若干种颜色（通常不超过256种）编制成颜色表，然后将图片中原有颜色用颜色表的索引来表示。这样原图片可以被大幅度有损压缩。适合于压缩网页图形等颜色数较少的图形，不适合压缩照片等色彩丰富的图形。

+ Alpha通道:在原有的图片编码方法基础上，增加像素的透明度信息。图形处理中，通常把RGB三种颜色信息称为红通道、绿通道和蓝通道，相应的把透明度称为Alpha通道。多数使用颜色表的位图格式都支持Alpha通道。

+ 色彩深度:色彩深度又叫色彩位数，即位图中要用多少个二进制位来表示每个点的颜色，是分辨率的一个重要指标。常用有1位（单色），2位（4色，CGA），4位（16色，VGA），8位（256色），16位（增强色），24位和32位（真彩色）等。色深16位以上的位图还可以根据其中分别表示RGB三原色或CMYK四原色（有的还包括Alpha通道）的位数进一步分类，如16位位图图片还可分为R5G6B5，R5G5B5X1（有1位不携带信息），R5G5B5A1，R4G4B4A4等等。

+ 位图是渲染到屏幕上的图片格式，所以我们在拿到图片需要将他展示渲染时就必须要转换为位图，也就是我们所说的解压缩。

+ 关于图片解压后的大小和原始图片的大小没什么关系，只和图片的像素有关
    ```
        解压后的图片大小 = 图片的像素宽 * 图片的像素高 * 每个像素点所占有的字节
    ```

## 强制解压缩的原理

+ 既然图片不可解压缩不可避免，那有什么办法可以优化解压缩这个步鄹而减少页面卡顿呢。其实我们可以考虑将图片解压缩放在非主线程处理，主线程只专注处理自己UI渲染就好了。现在几个主流的框架基本也是这样处理的。


### 参考链接

+ [谈谈iOS中图片的解压缩](http://blog.leichunfeng.com/blog/2017/02/20/talking-about-the-decompression-of-the-image-in-ios/)
