---
layout: mypost
title: iOS核心动画高级技巧
---

# 图层的树状结构

### CAShapeLayer是一个通过矢量图形而不是bitmap来绘制的图形子类。你指定诸如颜色和颜色线宽等属性，用CGPath来定义想要绘制的图形，最后都是CAShapeLayer自动渲染出来的。相比之下，使用CAShapeLayer有以下一些优点
+ 渲染速度快。CAShapeLayer使用了硬件加速，绘制同一图形会比Core Graphics快很多
+ 高效使用内存。一个CAShapeLayer不需要像普通CALayer一样创建一个寄宿图形，所以无论多大，度不会占用太多内存。
+ 不会被图层边界裁剪掉。一个CAShapeLayer可以在边界之外绘制。你的图层路径不会像在使用Core Animation的普通CALayer一样被裁剪掉
+ 不会出现像素画。使用CAShapeLayer做3D转换时，它不会像普通图层一样变得像素化。

### CATextLayer

### CATransformLayer


### CAGradientLayer

### CAReplicatorLayer

### CAScrollLayer

### CATiledLayer

### CAEmitterLayer

### CAEAGLayer 


### AVPlayerLayer 


# 隐式动画

### CATransaction 


# 显式动画

+ 属性动画

+ 关键帧动画

+ 虚拟属性

+ 动画组

+ 隐式过度

+ 对图层树的动画

### 图层时间

+ CAMediaTiming协议

+ 相对时间

+ fillMode

+ 层级关系时间

+ 全局时间和本地时间
1. CoreANimation有一个全局时间的概念，内核机器时间，在所有进程是全局的。我们可以通过 ``` CFTimeInterval time = CACurrentMediaTIme()```来访问。返回值是设备自从上次启动后的秒数。

+ 暂停、倒回、快进动画

+ 手动动画

+ 自定义缓冲函数

+ 更加复杂的动画曲线

+ 基于关键帧的缓冲

+ 流程自动化动画

### 基于定时器动画

+ 定时帧


### 缓冲

+ 动画速度

+ CAMediaTimingFunction

### 性能调优

1. CPU VS GPU
    + 关于绘图和动画的两种处理方式，CPU和GPU。 对于图像处理，通常来说使用GPU处理会更快，因为GPU处理图像时对高度并行浮点运算做了优化。所以我们想尽可能的把屏幕渲染的工作交给硬件去处理。但是问题在于GPU并没有无限制处理性能，一旦GPU资源用完，性能就会开始下降。
    + 大多是动画都是智能选择利用GPU和CPU来处理。这样可以使得CPU资源不会那么容易被耗尽。

2. 动画处理
    + Core Animation在应用内核应用间都会需要用到它。一个简单的动画可能同步显示多个app的内容，例如iPad多个程序的手饰切换。所以其实动画和屏幕上的组合图层实际上是被一个单独的进程管理。这个进程是叫做渲染服务。在iOS6 之前的版本叫做SpringBoard 在iOS6之后叫做BackBoard。
    + 当运行一段动画时，可以分离出四个步骤:
        1. 布局：准备图层/视图的层级关系，以及设置图层属性（位置，背景色，边框等）。
        2. 显示：这是图层的内容被绘制的阶段。绘制方法可能涉及到```drawRect:``` 和 ``` drawLayer:inContext ```。
        3. 准备：CoreAnimation 准备发送动画数据到渲染服务阶段。同时，CoreAnimation将要执行一些别的事务，如解码动画过程中将要显示的图片和时间点。
        4. 提交：CoreAnimation 打包好所有图层和动画属性，通过IPC（内部处理通信）发送到渲染服务进行处理显示。
    + 这些过程仅仅在应用之内的处理，在真正显示出来之前还有很多工作需要处理。当打包的图层和动画到达渲染服务进程，他们会被反序列化来形成另一个叫做渲染树的图层树。
        5. 对所有图层属性计算中间值，设置OpenGL几何形状，纹理化，来执行渲染。
        6. 在屏幕上渲染显示。

3. 善用Instruments工具找到性能瓶颈并优化

### 高效绘图

+ 矢量图形

+ 脏矩形

1. 为了减少不必要的绘制，Mac OS和iOS设备将会把屏幕区分为需要重绘的区域和不需要重绘的区域。那些需要重绘的部分就称为脏矩形。

+ 异步绘制

+ 隐式绘制


+ 文本

+ 光栅栏

+ 离屏渲染，图层的以下属性将会出发离屏渲染。
    1. iOS10 之前的圆角(和maskToBounds一起使用时)，可以考虑使用CAShapeLayer绘制圆角避免离屏渲染
    2. 图层蒙版 
    3. 阴影

+ 混合和过度绘制
    1. 不到必须适合不要使用透明图层，设置opaque属性为YES
    2. 明智的使用ShouldRasterize属性

+ 减少图层的数量

+ 对象回收

+ Core Graphices绘制


### 参考链接

> iOS核心动画高级技巧