---
layout: mypost
title: App与H5页面登录态同步方案
---

### 背景：

+ 现在App中存在多种登录方式，App的native登录页 以及 h5 自身的登录页，所以会出现如果在app内使用h5登录页登录后，app上仍然没有登录态的问题，本次就是解决登录态同步问题。

### 方案(整合原有的login和getSession两个scheme的功能）：

+ login:
+ 调用login会唤起登录页面，并且会清掉本地session，但是不会回调h5结果，可能出现唤起页面后用户取消，然后本地无登录态的问题

+ getSession:
+ 会回调h5页面session，但是只会取本地缓存，所以在未登录情况下取到的为空

### 调整：

+ 完善login的scheme，增加force参数（增加force是为了避免特殊情况下H5从App端拿到无效session失效）,bluestone://login/{“force”:”1”,”callback”:”jsFunction”}

    1. 当force为1时，不论本地是否已登录，都会唤起登录页面，登录完成后更新本地缓存，并回调h5页面session，回调格式
    2. 当force为0时，如果本地已登录，则直接取本地缓存的session回调js；否则，唤起登录页面，并在登录完成后更新本地缓存，再回调js。
    3. 回调增加bluestone域名限制，非bluestone域名情况下进行正常登录逻辑，但不进行js回调

+ 登录成功后回调h5页面session，格式如下，JsFunction为h5页面自定义的名字，没传情况下默认使用loginCallback来回调

```
    JsFunction
    {
        "session": "MC4xMTg3MzM0Nzg0MzE0OTMyOQ.IQLWfdIbAQZL62A-rT0Yaa0Xo2E”,
        "errno": 0,
        "message": "\u767b\u5f55\u6210\u529f"
    }
```

+ 注：force为1的情况，仅限h5页面校验session失败的情况下使用，避免频繁调用登录界面影响体验


### 其他：

a）如果已登录，则app仍会在入口页链接上拼接好相应的参数（遵循原来的拼接规范），后续页面内的二级跳转的session由h5页面自行维护（存cookie或续续调用login方法来缓存等方式都可以）
b）如果app未登录(或者入口页面链接没有要求登录态），可能会存在N（N>=1）级跳转后需要使用session的情况，这时通过scheme唤起app进行登录，登录完成后在当前页面回调js方法通知h5页面登录态，同时h5页面需要维护好当前的session，以便于跳转或返回到其他页面后能正常使用session。